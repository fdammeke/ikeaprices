<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IKEA price comparison magic button</title>
<link href="https://fonts.googleapis.com/css?family=Comfortaa|Roboto|Roboto+Condensed" rel="stylesheet">
<style>
body {
  width: 80%;
  margin: 0 auto;
  font-family: 'Comfortaa', serif;
  min-height: 100%; 
/*   font-size: 00%; */
}

h1 {
  font-family: 'Comfortaa', serif;
  padding: 30px;
  text-align: center;
  background-color: #0051ba; /*0167CB; #c33399;*/
  color: white;
}

ul {
  font-family: 'Roboto Condensed', sans-serif;
}
li {
  display:inline-block;
}
li.selected {
  /*background-color: lightgreen;*/
}
li.selected a {
  color: #f63;
}
a {
  color: #3399fd; /* #0051ba; */
  text-decoration: none;
}
a:hover {
  color: #0051ba;
  text-decoration: none;
}
#cntList {
  font-weight: bold;
}

#bookmarklet {
  padding: 10px;
  background-color: #0051ba;
  color: white;
  font-weight: bold;
  border-radius: 4px;
}

.footer {
  padding: 10px;
  text-align: center;
  background-color: #eee;
  color: #333;
  font-size: 75%;
}
</style>
</head>
<body>

<h1>IKEA price comparison magic button</h1>

<h2>1. Choose countries for comparison:</h2>
<div id = "countries">
<h3>Asia Pacific</h3>
<ul>
<li><a href="http://www.ikea.com/au/en/">Australia</a></li>
<li><a href="http://www.ikea.com/cn/zh/">China</a></li>
<li><a href="http://www.ikea.com/hk/zh/">Hong Kong</a></li>
<li><a href="http://www.ikea.com/id/in/">Indonesia</a></li>
<li><a href="http://www.ikea.com/jp/ja/">Japan</a></li>
<li><a href="http://www.ikea.com/my/ms/">Malaysia</a></li>
<li><a href="http://www.ikea.com/sg/en/">Singapore</a></li>
<li><a href="http://www.ikea.com/kr/ko/">South Korea</a></li>
<li><a href="http://www.ikea.com/th/th/">Thailand</a></li>
</ul>
<h3>Europe</h3>
<ul>
<li><a href="http://www.ikea.com/at/de/">Austria</a></li>
<li><a href="http://www.ikea.com/be/nl/">Belgium</a></li>
<li><a href="http://www.ikea.com/hr/hr/">Croatia</a></li>
<li><a href="http://www.ikea.com/cz/cs/">Czech Republic</a></li>
<li><a href="http://www.ikea.com/dk/da/">Denmark</a></li>
<li><a href="http://www.ikea.com/fi/fi/">Finland</a></li>
<li><a href="http://www.ikea.com/fr/fr/">France</a></li>
<li><a href="http://www.ikea.com/de/de/">Germany</a></li>
<li><a href="http://www.ikea.com/hu/hu/">Hungary</a></li>
<li><a href="http://www.ikea.com/ie/en/">Ireland</a></li>
<li><a href="http://www.ikea.com/it/it/">Italy</a></li>
<li><a href="http://www.ikea.com/lt/lt/">Lithuania</a></li>
<li><a href="http://www.ikea.com/nl/nl/">Netherlands</a></li>
<li><a href="http://www.ikea.com/no/no/">Norway</a></li>
<li><a href="http://www.ikea.com/pl/pl/">Poland</a></li>
<li><a href="http://www.ikea.com/pt/pt/">Portugal</a></li>
<li><a href="http://www.ikea.com/ro/ro/">Romania</a></li>
<li><a href="http://www.ikea.com/ru/ru/">Russia</a></li>
<li><a href="http://www.ikea.com/rs/sr/">Serbia</a></li>
<li><a href="http://www.ikea.com/sk/sk/">Slovakia</a></li>
<li><a href="http://www.ikea.com/es/es/">Spain</a></li>
<li><a href="http://www.ikea.com/se/sv/">Sweden</a></li>
<li><a href="http://www.ikea.com/ch/de/">Switzerland</a></li>
<li><a href="http://www.ikea.com/gb/en/">United Kingdom</a></li>
</ul>
<h3>Middle East and North Africa</h3>
<ul>
<li><a href="http://www.ikea.com/jo/en/">Jordan</a></li>
<li><a href="http://www.ikea.com/kw/en/">Kuwait</a></li>
<li><a href="http://www.ikea.com/ma/fr/">Morocco</a></li>
<li><a href="http://www.ikea.com/sa/en/">Saudi Arabia</a></li>
</ul>
<h3>North America</h3>
<ul>
<li><a href="http://www.ikea.com/ca/en/">Canada</a></li>
<li><a href="http://www.ikea.com/us/en/">United States</a></li>
</ul>
</div>

<h2>2. Drag this link to your bookmarks bar:</h2>
<p>
<a id="bookmarklet" href="">
check price
</a>
</p>
<!-- Selected countries: <span id = 'cntList'></span> -->
<h2>3. Navigate to an IKEA product page, like <a href="http://www.ikea.com/be/nl/catalog/products/24286205" target="_blank">this</a></h2>
<h2>4. Click the "compare prices" button you dragged in the 2nd step</h2>

<!-- TODO: screencast gif here (to the right) -->
<div class = "footer">
Note: 
<!-- This page is not affiliated with IKEA.  -->
The code relies on the IKEA website structure and may stop working if that changes. 
Some products have different article numbers in different countries, for them price comparison will not work.
</div>
<script>
function minify(code) {
	// very simple minification (and not overly aggressive on whitespace)
	code = code.split(/\r\n|\r|\n/g);
	var i=0, len=code.length, t;

	for (; i<len; i++) {
		// note: this doesn't support multi-line strings with slashes
		t = code[i].trim();
		code[i] = t;
	}
	return code.join('').replace(/;$/, '');
}

function asBookmarklet(code) {
	code = minify(code);
	code = '(function(){' + code + '})()';
	return 'javascript:' + encodeURIComponent(code);
}
</script>

<script>
// var hrefStart = "javascript:(function()%7Bvar%20id%20%3D%20document.getElementById(%22itemNumber%22).innerText.replace(%2F%5C.%2Fg%2C%20%22%22)%3Bvar%20countries%20%3D%20%5B"; 
// var hrefStart = "javascript:(function()%7Bvar%20id%20%3D%20currentItem%3Bvar%20cnt%20%3D%20window.location.pathname.slice(1,6)%3Bvar%20countries%20%3D%20%5B"; 

var hrefStart = "javascript:(function()%7Bvar%20id%20%3D%20document.querySelector(%22span%5Bitemprop%3DproductID%5D%22).innerText.replace(%2F%5C.%2Fg%2C'')%3Bvar%20cnt%20%3D%20window.location.pathname.slice(1,6)%3Bvar%20countries%20%3D%20%5B";

//var hrefMid = "'de%2Fde'%2C%20'fr%2Ffr'%2C%20'nl%2Fnl'";

// var hrefEnd = "%5D%3Bcountries.forEach(function(cnt)%20%7BjQuery.get(%22http%3A%2F%2Fwww.ikea.com%2F%22%2Bcnt%2B%22%2Fcatalog%2Fproducts%2F%22%2Bid%2B%22%2F%22%2C%20function%20(data)%20%7Bvar%20doc%20%3D%20new%20DOMParser().parseFromString(data%2C%20%22text%2Fhtml%22)%3Bvar%20price%20%3D%20doc.evaluate(%22%2F%2Fmeta%5B%40name%3D'price'%5D%2F%40content%22%2C%20doc%2C%20null%2C%200%2C%20null).iterateNext()%3Bvar%20text%20%3D%20cnt.substr(0%2C2)%2B'%3A%20'%2B(price%20%3D%3D%3D%20null%20%3F%20%22-%22%20%3A%20price.textContent)%3Bvar%20priceDiv%20%3D%20document.createElement(%22div%22)%3BpriceDiv.appendChild(document.createTextNode(text))%3Bdocument.getElementById(%22prodPrice%22).appendChild(priceDiv)%3B%7D)%3B%7D)%7D)()";
var hrefEnd = "%5D.filter(el%3D%3Eel!%3Dcnt)%3Bcountries.forEach(function(cnt)%20%7Bvar%20href%20%3D%20%22http%3A%2F%2Fwww.ikea.com%2F%22%2Bcnt%2B%22%2Fcatalog%2Fproducts%2F%22%2Bid%2B%22%2F%22%3BjQuery.get(href%2C%20function%20(data)%20%7Bvar%20doc%20%3D%20new%20DOMParser().parseFromString(data%2C%20%22text%2Fhtml%22)%3Bvar%20price%20%3D%20doc.evaluate(%22%2F%2Fmeta%5B%40name%3D'price'%5D%2F%40content%22%2C%20doc%2C%20null%2C%200%2C%20null).iterateNext()%3Bvar%20text%20%3D%20cnt.substr(0%2C2)%2B'%3A%20'%2B(price%20%3D%3D%3D%20null%20%3F%20%22-%22%20%3A%20price.textContent)%3Bvar%20priceDiv%20%3D%20document.createElement(%22div%22)%3Bvar%20priceA%20%3D%20document.createElement(%22a%22)%3BpriceA.setAttribute(%22href%22%2C%20href)%3BpriceA.appendChild(document.createTextNode(text))%3BpriceDiv.appendChild(priceA)%3Bdocument.getElementById(%22prodPrice%22).appendChild(priceDiv)%3B%7D)%3B%7D)%7D)()";


var chosen = document.getElementsByClassName('selected');
var button = document.getElementById('bookmarklet');

function checkChosen() {
  if (chosen.length == 0) {
    // button.style.display = 'none';
    button.style.backgroundColor = 'lightgray';
  } else {
    // button.style.display = 'inline';
    button.style.backgroundColor = '#0051ba';
  }
}
checkChosen();

function updateButton() {
  // modify actual js code for the bookmarklet
  if (chosen.length > 0) {
	  var text = "'" + [...chosen].map((el) => el.firstChild.href.slice(-6, -1)).join("','") + "'";
	  button.href = hrefStart + encodeURIComponent(text) + hrefEnd;
  } else {
	  button.href = "";
  }
}

function refreshScript() {
  //chosen = document.getElementsByClassName('selected');
  checkChosen();
//   var text = [...chosen].map((el) => el.innerText).join(", ");
//   document.getElementById('cntList').innerText = text;

  var text = " (" + [...chosen].map((el) => el.firstChild.href.slice(-6, -4)).join(", ") + ")";
  button.innerText = "check price" + (chosen.length > 0 ? text : "");
  
  updateButton();
}
function toggleSelection(e) {
  e.classList.toggle('selected');
  refreshScript();
}

var items = document.getElementsByTagName('li');

[...items].forEach(elem => elem.addEventListener("click", function(el) {el.preventDefault(); toggleSelection(this);}));

var regions = document.getElementsByTagName('h3');

[...regions].forEach(elem => elem.addEventListener("click", function(el) {el.preventDefault();
	console.log(this.nextElementSibling.children);
	console.log(el);
	[...this.nextElementSibling.children].forEach(li => toggleSelection(li));}));


</script>
</body>
</html>
